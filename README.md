# 系统架构设计流程

## 核心业务描述：

==**XXX系统是围绕着XXX业务展开设计的，主要解决了XXX问题，提供了XXX的服务，期望达到XXX的效果**==

> 月辰云图库平台主要围绕着图片业务展开设计的，为用户提供了如下服务
>
> 1. 公共平台：图片的浏览下载上传。
> 2. 个人空间：自己对图片进行管理，上传不受管理员审核限制，并且可以分析自己的空间使用情况
> 3. 团队空间：可以邀请成员加入空间，具备一套完全独立的的鉴权体系，包含管理员，只读，读写权限
>
> 依据提供的这些服务，用户可以将本项目作为普通的素材网站，也可以创建自己的空间来作为云盘，或者可以对自己的群体进行一个团队空间的创建。

## 系统上下文

描述了系统在业务环境中的位置，作用以及与其他系统交互关系，从宏观的角度定义系统边界与外部依赖

主要解决这些问题：

1. 系统有哪些角色？
2. 这些角色能用我们的系统干什么事情？
3. 我们要实现用户的需求是否需要依赖外部服务？

> - 管理员和普通用户角色，主要能干这些事情
>   - 管理员：图片的管理与审核，批量导入图片，对用户的管理
>   - 用户：浏览访问图片，上传下载图片，开通自己的个人空间，团队空间，分享自己创建的空间的使用情况
> - 依赖外部服务分析：
>   - 对象存储云服务，用来存储图片

## 核心业务流程与模块

**思考范式：**

- 本系统有XXX这些核心模块，作用分别是：XXX
- 为了完成XXX需求，需要设计XXX流程，并且其中还依赖XXX服务

> 本系统包含用户，图片，空间三个核心模块，作用分别是：
>
> 用户：任何互联网项目的基础服务模块，提供网站资源访问的入口能力
>
> 图片：本项目的核心业务，本系统设计就是围绕着图片的一系列操作展开的
>
> 空间：类比Java中的线程私有资源，实现"自己就是自己空间的管理员"目的

## 关键技术方案

也就是对重难点业务实现流程进行**方案设计**，这期间会得到依赖哪些中间件，组件，服务，作为技术架构选项依据

> - 会话保持：基础实现是使用Session
>   - 保存在系统上下文中：缺点是无法在集群环境进行会话保持
>   - 分布式Session：spring框架集成了redis存储session的方案`spring-session-data-redis`可以解决集群环境下的会话保持问题
> - 图片存储：
>   - 主流方案是对象存储服务，包括开源的MinIO，对象存储云服务等等
>   - 这里选择腾讯云的对象存储云服务，主要是便宜，对接起来快，而且通过数据万象服务可以对图片进行分析以供后续业务使用
> - 用户空间：维护一张空间表，主要与图片表进行交互，上传图片的信息还是在图片表，只不过新增一个归属哪个空间ID的字段
> - 限流策略：多规则+滑动窗口实现思路，基于Redis和Lua脚本实现
> - 更多实现方案查阅项目Wiki

## 功能模块清单

定义功能域以及功能（模块和接口）

> 1. 用户模块：
>    1. 提供用户注册，登录，注销，权限管理，
>    2. 管理员对用户的统一管理功能
> 2. 图片模块：
>    1. 用户图片上传，下载图片，查看与搜索图片List，查看图片详情，图片分享，图片搜索（基础信息搜索，以图搜图，颜色搜索），图片编辑（基础编辑，AI扩图，团队空间协同编辑图片等）
>    2. 管理员图片审核，编辑，删除，批量抓取等功能
> 3. 个人空间模块：
>    1. 用户个人空间的创建
>    2. 空间级别与限额管控
>    3. 管理员管理全局空间
> 4. 团队空间模块：
>    1. 创建团队空间
>    2. 空间成员管理：独立一套RBAC鉴权，成员邀请
> 5. 空间分析
>    1. 个人空间使用情况分析（按照使用空间，已上传类别等进行分析）
>    2. 管理员全空间分析

## 数据建模

数据建模主要是针对业务流程设计数据模型并且梳理出各个模型之间的关系。思路是先划分出模块层级并设计出核心数据模型，然后分析模块间数据模型的关系（避免模块内数据模型设计出现遗漏），最后对模块内的数据模型进行设计（由大到小，由外到内）

> 如下是最核心的表，分别是图片表，用户表，空间表，空间成员表，此外，由于空间鉴权体系角色不多，可以将用户空间相关的表抽离成JSON文件在项目文件中存储
>
![输入图片说明](https://foruda.gitee.com/images/1748685343557514001/3ce94bb0_11330093.png "屏幕截图")

```json
{
  "permissions": [
    {
      "key": "spaceUser:manage",
      "name": "成员管理",
      "description": "管理空间成员，添加或移除成员"
    },
    {
      "key": "picture:view",
      "name": "查看图片",
      "description": "查看空间中的图片内容"
    },
    {
      "key": "picture:upload",
      "name": "上传图片",
      "description": "上传图片到空间中"
    },
    {
      "key": "picture:edit",
      "name": "修改图片",
      "description": "编辑已上传的图片信息"
    },
    {
      "key": "picture:delete",
      "name": "删除图片",
      "description": "删除空间中的图片"
    }
  ],
  "roles": [
    {
      "key": "viewer",
      "name": "浏览者",
      "permissions": [
        "picture:view"
      ],
      "description": "查看图片"
    },
    {
      "key": "editor",
      "name": "编辑者",
      "permissions": [
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "查看图片、上传图片、修改图片、删除图片"
    },
    {
      "key": "admin",
      "name": "管理员",
      "permissions": [
        "spaceUser:manage",
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "成员管理、查看图片、上传图片、修改图片、删除图片"
    }
  ]
}
```

## 数据流分析

主要考虑系统**数据的输入和输出**

> 数据输入主要是用户注册，上传的图片
>
> 数据输出主要是提供下载，访问等业务功能

## 技术架构

主要分为内部依赖和外部依赖

- 内部依赖包括**实现业务功能**所需要的依赖，包括但不限于
  - 存储层：MySQL，PG，Gauss，Redis
  - 服务层：Spring系列开发框架，Mybatis，MQ，定时任务，SSO，ES
  - 展示层：Vue，React，UI组件库
- 外部依赖包括**部署，运维，监控，高可用组件，容灾**等方面的依赖，包括但不限于
  - 云服务器，Docker，Nginx，日志云，MyCat-eye，K8s，Spring Cloud相关组件（配置中心，注册中心，RPC框架），网关，监控告警组件等

> ### 本项目主要使用
>
> **内部依赖**
>
> - 存储层：MySQL，Redis，腾讯云对象存储服务
> - 服务层：SSM开发框架，Mybatis-Plus，hutool，Swagger，分页插件，Sa-Token 权限认证，lombok，spring邮箱服务， Spring Session，腾讯云对象存储服务SDK
> - 展示层：Vue，UI组件库
>
> **外部依赖**
>
> - 阿里云服务器，宝塔面板（集成各种监控，日志，告警等工具）

## 脚手架搭建

根据功能模块清单进行代码工程脚手架搭建，需要确定好架构风格：**单体，微服务，DDD**

## 威胁分析

系统的各个层级入口（前端，后端，第三方服务等等）是否存在网络安全风险

> SSL证书配置
>
> 接口限流防刷
>
> 对象存储服限额，配置监控等

## 部署方案

- 部署到什么地方？（机房还是云服务）
- 用什么部署？（Docker还是Tomcat）
- 是否集群部署？
- 有没有灰度发布？

## 交付件归档

1. **需求分析报告：**包括需求分析文档、用例分析文档、需求规格说明书等。 
2. **设计文档：**包括概要设计文档、详细设计文档、架构设计**文档**等。 
3. **编码：**源代码和可执行**文件**。 
4. **测试文档：**包括测试计划、测试用例、测试报告等。 
5. **用户手册：**提供给用户使用**软件**的详细说明和操作指南。 
6. **部署文档：**包括**软件**安装说明、配置文件、**系统**部署**文档**等。 
7. **维护文档：**包括故障排除指南、维护手册、升级文档等。

## 非功能性需求预研

主要围绕性能，扩展性，可移植性，可用性等维度进行进一步设计